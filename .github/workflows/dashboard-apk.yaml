name: Build Dashboard Android APK

on:
  push:
    branches:
      - master
      - release

env:
  MANIFEST_URL: https://oneuptime.com/dashboard/manifest.json
  PWA_ORIGIN: https://oneuptime.com
  PACKAGE_ID: com.oneuptime.dashboard
  HOST_NAME: oneuptime.com

jobs:
  build-apk:
    runs-on: ubuntu-latest
    env:
      MANIFEST_SOURCE_PATH: Dashboard/public/manifest.json
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute version numbers
        id: version
        run: |
          set -euo pipefail
          VERSION_PREFIX=$(cat VERSION_PREFIX | tr -d ' \n')
          VERSION_NAME="${VERSION_PREFIX}.${GITHUB_RUN_NUMBER}"
          echo "name=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "code=${GITHUB_RUN_NUMBER}" >> $GITHUB_OUTPUT

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build APK
        id: build_apk
        env:
          VERSION_NAME: ${{ steps.version.outputs.name }}
          VERSION_CODE: ${{ steps.version.outputs.code }}
          SIGNING_KEYSTORE_BASE64: ${{ secrets.ANDROID_APK_SIGNING_KEYSTORE_BASE64 }}
          SIGNING_KEY_ALIAS: ${{ secrets.ANDROID_APK_SIGNING_KEY_ALIAS }}
          SIGNING_KEY_PASSWORD: ${{ secrets.ANDROID_APK_SIGNING_KEY_PASSWORD }}
          SIGNING_STORE_PASSWORD: ${{ secrets.ANDROID_APK_SIGNING_STORE_PASSWORD }}
        run: |
          set -euo pipefail
          APK_PATH=$(./scripts/GHA/build_apk.sh)
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "Found APK at $APK_PATH"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-apk-${{ steps.version.outputs.name }}
          path: ${{ steps.build_apk.outputs.apk_path }}
