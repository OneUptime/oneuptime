staging_rollback_helm-chart:
  stage: RollbackIfSmokeTestFail
  script:
    - chmod +x ./ci/scripts/deployment-setup.sh
    - ./ci/scripts/deployment-setup.sh
    - chmod +x ./ci/scripts/deployment-staging-setup.sh
    - ./ci/scripts/deployment-staging-setup.sh
    # Rollback backend
    - chmod +x ./ci/scripts/job-status.sh
    - export smoke_test_staging_status=`./ci/scripts/job-status.sh smoke_test_staging`
    - if [[ $smoke_test_staging_status == \"success\" ]]; then exit 0; fi
    - sudo $HOME/google-cloud-sdk/bin/kubectl rollout undo deployment/fi-helm-chart
  only:
    refs:
      - master
  except:
    - $SMOKE_TEST_STATUS == "success"

production_rollback_hekm-chart:
  stage: RollbackIfSmokeTestFail
  script:
    - chmod +x ./ci/scripts/deployment-setup.sh
    - ./ci/scripts/deployment-setup.sh
    - chmod +x ./ci/scripts/deployment-production-setup.sh
    - ./ci/scripts/deployment-production-setup.sh
    # Rollback backend
    - chmod +x ./ci/scripts/job-status.sh
    - export smoke_test_production_status=`./ci/scripts/job-status.sh smoke_test_production`
    - if [[ $smoke_test_production_status == \"success\" ]]; then exit 0; fi
    - sudo $HOME/google-cloud-sdk/bin/kubectl rollout undo deployment/fi-helm-chart
  only:
    refs:
      - release